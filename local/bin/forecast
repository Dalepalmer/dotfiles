#!/usr/bin/env bash
#
# Generates sparklines for the next 15 minutes of precipitation in your current
# location. This relies on `whereami` (a Mac OS X utility), `jq`, and `spark`.
# Install all of them using homebrew:
#
#   brew install whereami jq spark
#
# Then:
#
#   forecast
#
sparkfile="/tmp/forecast.spark"
minutes=60

usage() { echo "Usage: forecast [-m <1...60>]" 1>&2; exit 1; }

while getopts ":m:" flag; do
  case "${flag}" in
    m)
      minutes=${OPTARG}
      ;;
    *)
      usage
      ;;
  esac
done
shift $((OPTIND-1))

if [ ! -f "$sparkfile" ]; then
  touch $sparkfile
fi

last=$(stat -f %m $sparkfile)
now=$(date +%s)

if (( ("$now" - "$last") > 120 )); then
  sparklines=$(curl -Ss https://api.forecast.io/forecast/$FORECAST_API_KEY/$(whereami) |
            jq ".minutely.data[:$minutes] | .[].precipIntensity * 1000" |
            spark)

  echo $sparklines | tee $sparkfile
else
  cat $sparkfile
fi
